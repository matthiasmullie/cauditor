<script src="/assets/js/vendor/d3.min.js"></script>
<script src="/assets/js/vendor/d3plus.min.js"></script>
<script src="/assets/js/Cauditor.js"></script>
<script src="/assets/js/visualizations/Data.js"></script>
<script src="/assets/js/visualizations/Abstract.js"></script>
<script src="/assets/js/visualizations/treemap/Abstract.js"></script>
<script src="/assets/js/visualizations/treemap/Method.js"></script>
<script src="/assets/js/visualizations/treemap/Class.js"></script>

{% include 'utils/project_navbar.html' %}

{% if not commit %}
    {% include 'utils/commits_missing.html' %}
{% else %}
    <div class="container">
        <div class="row" style="padding: 0;">
            <div class="col-md-12 columns">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <i class="fa fa-info-circle"></i>
                        Square size = lines of code. Square color = metric score. <strong>Focus on anomalies</strong>.

                        {# This link will expand below panel-body (see JS later in this tpl) #}
                        <a id="expand-panel">More&hellip;</a>
                    </div>
                    <div class="panel-body panel-more" style="display: none;">
                        <p>
                            The size of the square represents the amount of lines of code in that method/class.
                            The color is determined by the metric score, ranging from green to red. <br />
                            <strong>Red means worse</strong>.
                        </p>
                        <p style="margin-bottom: 0;">
                            Focus on really high or unexpected red spots. Red spots are not necessarily bad! Not all code is alike and different problems need different solutions.<br />
                            E.g. you're likely to find a higher complexity where your business logic lives.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        {% for class, grouped_charts in charts|groupby('basis')|sort(true) %}
            <div class="row">
                {% for chart in grouped_charts %}
                    <div id="{{ chart.code }}" class="col-xs-12 col-md-4 columns">
                        <h2>
                            <strong>{{ chart.name }}</strong>
                            <a href="/help#{{ chart.code }}" title="What is {{ chart.name }}?">
                                <i class="fa fa-question-circle"></i>
                            </a>
                        </h2>
                        <a href="/{{ project.name }}/{% if route.commit %}{{ commit.hash }}/{% endif %}{{ chart.code }}">
                            <span class="chart"></span>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <script>
        $.ajax({
            url: '{{ data.path|replace('{pwd}', '') }}/{{ data.filename|replace('{project}', project.name)|replace('{hash}', commit.hash) }}',
            datatype: 'json',
            jsonp: false,
            cache: true,
            success: function(data) {
                {% for chart in charts %}
                    var chart = new Cauditor(
                        {% if chart.basis == 'method' %}
                            new Cauditor.Visualization.Treemap.Method(),
                        {% elif chart.basis == 'class' %}
                            new Cauditor.Visualization.Treemap.Class(),
                        {% endif %}
                        new Cauditor.Data(data)
                    );

                    chart.draw('#{{ chart.code }} .chart', ['{{ chart.code }}', {{ chart.range }}, false]);
                {% endfor %}
            }
        });


        $('#expand-panel').click(function() {
            $(this).parent().hide().siblings('.panel-more').show();
            $(this).hide();
        });

        // automatically open the longer description if this is the user's first visit to this page
        if (!document.cookie.match(/(^|;\s*)metrics_panel=1($|\s*;)/)) {
            $('#expand-panel').click();
            document.cookie = 'metrics_panel=1; expires=Tue, 19 Jan 2038 03:14:08 UTC; path=/';
        }
    </script>
{% endif %}
