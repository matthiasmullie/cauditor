<div class="container">
    {% if not user %}
        <div class="container">
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                You are not currently logged in. Please <a class="alert-link" href="https://github.com/login/oauth/authorize?scope={{ github.scopes }}&client_id={{ github.id }}">authenticate via GitHub</a>.
            </div>
        </div>
    {% else %}
        {% set project_names = user_projects|map(attribute='name')|list %}
        {% set vendor = '' %}

        {#
            We could repos|sort(attribute='name') to ensure they're all in correct order (per vendor),
            but they seem to be in the correct order already and I don't really want vendors to be
            ordered alphabetically (I want username vendor first, then organizations)
        #}
        {% for repo in repos %}
            {% if vendor != repo.name.split('/')[0] %}
                {% if vendor != '' %}
                    <hr class="col-md-12" />
                {% endif %}

                {% set vendor = repo.name.split('/')[0] %}
                <h2 class="col-md-12"><strong>{{ vendor }}</strong></h2>
            {% endif %}

            <div class="col-md-3 repo {% if repo.private %}dimmed{% endif %}" data-repo="{{ repo.name }}">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a href="{{ repo.url }}" title="{{ repo.name }} on GitHub"><i class="fa fa-github"></i></a>
                        {% if repo.fork %}<i title="{{ repo.name }} is a fork" class="fa fa-code-fork"></i>{% endif %}
                        {% if repo.private %}<i title="{{ repo.name }} is private" class="fa fa-lock"></i>{% endif %}
                        {{ repo.name.split('/')[1] }}
                    </div>
                    <table class="table text-center">
                        <tr>
                            <td class="col-md-3">
                                <i class="fa fa-code-fork"></i> {{ repo.forks_count }}
                            </td>
                            <td class="col-md-3">
                                <i class="fa fa-star"></i> {{ repo.stargazers_count }}
                            </td>
                            <td class="col-md-6">
                                <i class="fa fa-code"></i> {% if repo.language %}{{ repo.language }}{% else %}&hellip;{% endif %}
                            </td>
                        </tr>
                    </table>
                    <div class="panel-footer buttons">
                        {# If any content in this div changes, make sure those changes are also reflected in the JS below (yes I'm lazy here, both should reuse same code) #}
                        <div class="btn-group btn-group-justified" role="group">
                            {% if repo.name in project_names %}
                                <a class="btn btn-danger link" data-repo="{{ repo.name }}" data-action="unlink"><i class="fa fa-unlink"></i> Unlink</a>
                                <a class="btn btn-success" href="/{{ repo.name }}">Metrics <i class="fa fa-caret-right"></i></a>
                            {% else %}
                                <a class="btn btn-primary {% if not repo.private %}link{% else %}disabled{% endif %}" href="#" data-repo="{{ repo.name }}" data-action="link"><i class="fa fa-link"></i> Link</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <script>
            $(document).on('click', '.link', function(e) {
                e.preventDefault();

                $.ajax({
                    url: '/api/link',
                    method: 'POST',
                    data: $(this).data()
                })
                .done(function(data) {
                    var $button = $(e.target),
                        $div = $button.parent('.buttons .btn-group').empty(),
                        action = $button.data('action');

                    if (action === 'link') {
                        // we just linked the repo
                        $div.append(
                            '<a class="btn btn-danger link" data-repo="'+ data.name +'" data-action="unlink"><i class="fa fa-unlink"></i> Unlink</a>' + "\n" +
                            '<a class="btn btn-success" href="/'+ data.name +'">See stats <i class="fa fa-caret-right"></i></a>'
                        );
                    } else if (action === 'unlink') {
                        // we just unlinked the repo
                        $div.append('<a class="btn btn-primary link" href="#" data-repo="'+ data.name +'" data-action="link"><i class="fa fa-link"></i> Link</a>');
                    }
                })
                .fail(function() {
                    // @todo better error handling; this is piss-poor!
                    alert('Failed to link project & this error handling is extremely poor! Try logging in again?');
                });
            });

            $.ajax({
                url: '/api/repos',
                method: 'GET'
            })
            .done(function(data) {
                var existing = [],
                    current = data.map(function(repo) {
                        return repo.name;
                    });

                $('.repo').each(function() {
                    existing.push($(this).data('repo'));
                });

                if (existing.sort().toString() !== current.sort().toString()) {
                    // @todo: ideally, I would re-render in-page, not refresh
                    location.reload();
                }
            })
        </script>
    {% endif %}
</div>
